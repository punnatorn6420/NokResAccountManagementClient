<div class="p-6 bg-white dark:bg-black rounded-xl shadow-md">
  <div class="flex justify-between items-center mb-6">
    <div>
      <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-300">
        Password Rotation Logs
      </h2>
      <p class="text-sm text-gray-500 mt-1">
        Review password reset activities and filter by keyword.
      </p>
    </div>
    <div class="flex items-center gap-2">
      <button
        pButton
        icon="pi pi-refresh"
        class="p-button-text p-button-sm"
        label="Refresh now"
        (click)="loadLogs({ silent: false })"
      ></button>
    </div>
  </div>

  <div
    *ngIf="errorMessage"
    class="mb-4 p-3 rounded-md bg-red-50 text-red-700 border border-red-200"
  >
    <i class="pi pi-exclamation-triangle mr-2"></i>
    <span>{{ errorMessage }}</span>
  </div>

  <p-table
    stripedRows
    [value]="logs"
    [loading]="loading"
    [rowHover]="true"
    [showGridlines]="true"
    responsiveLayout="scroll"
    class="shadow rounded overflow-hidden"
    [tableStyle]="{ 'min-width': '900px' }"
    styleClass="p-datatable-sm"
  >
    <ng-template #caption>
      <div class="flex justify-between items-center flex-col sm:flex-row gap-3">
        <button
          pButton
          label="Clear"
          icon="pi pi-filter-slash"
          class="p-button-outlined p-button-secondary dark:!text-gray-300"
          (click)="clearFilters()"
        ></button>

        <p-iconfield iconPosition="left" class="ml-auto w-full sm:w-auto">
          <p-inputicon>
            <i class="pi pi-search"></i>
          </p-inputicon>
          <input
            pInputText
            type="text"
            [(ngModel)]="keyword"
            placeholder="Search by account, status, message, or date"
            (ngModelChange)="onKeywordChange($event)"
            class="w-full sm:w-[360px]"
          />
        </p-iconfield>
      </div>
    </ng-template>
    <ng-template pTemplate="header">
      <tr class="bg-gray-100 !text-sm text-gray-700">
        <th>ID</th>
        <th>Account ID</th>
        <th class="min-w-[360px]">Message</th>
        <th class="!text-center">Status</th>
        <th class="!text-center">Created By</th>
        <th class="!text-center">Created At</th>
        <th class="!text-center">View</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-row>
      <tr class="hover:bg-gray-50 transition duration-200 ease-in-out !text-sm">
        <td class="font-medium text-gray-800">{{ row.id }}</td>
        <td>{{ row.accountId }}</td>
        <td class="text-gray-700">
          <div class="flex items-center gap-2">
            <button
              type="button"
              class="text-left flex-1 min-w-0"
              (click)="openMessage(row)"
              [disabled]="!(row.message && row.message.trim())"
            >
              <span class="block max-w-[560px] truncate">
                {{ row.message || "-" }}
              </span>
            </button>
          </div>
        </td>

        <td class="!text-center">
          <span [ngClass]="getStatusClass(row.status)">
            {{ row.status || "-" }}
          </span>
        </td>
        <td class="!text-center">{{ row.createdBy || "-" }}</td>
        <td class="!text-center tracking-tighter">
          {{ row.createdAt ? (row.createdAt | date: "dd/MM/yy HH:mm") : "-" }}
        </td>
        <td class="!text-center">
          <button
            pButton
            type="button"
            icon="pi pi-eye"
            class="p-button-rounded"
            (click)="openMessage(row)"
            [disabled]="!(row.message && row.message.trim())"
            pTooltip="View full message"
            tooltipPosition="left"
          ></button>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="7">
          <div class="py-10 text-center text-gray-500">
            {{ keyword ? "No logs match your search." : "No logs available." }}
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <div class="flex justify-end items-center gap-2 mt-3">
    <small class="text-gray-500">
      Last refreshed:
      {{ lastRefreshedAt ? (lastRefreshedAt | date: "short") : "-" }}
    </small>
  </div>
  <p-dialog
    header="Log message"
    [(visible)]="messageDialogVisible"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [dismissableMask]="true"
    [style]="{ width: 'min(900px, 95vw)' }"
  >
    <div class="space-y-3">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm my-2">
        <div class="text-gray-600">
          <span class="font-medium text-gray-800">Account:</span>
          {{ selectedLog?.accountId ?? "-" }}
        </div>
        <div class="text-gray-600">
          <span class="font-medium text-gray-800">Status:</span>
          <span class="ml-2" [ngClass]="getStatusClass(selectedLog?.status)">
            {{ selectedLog?.status ?? "-" }}
          </span>
        </div>
        <div class="text-gray-600">
          <span class="font-medium text-gray-800">Created By:</span>
          {{ selectedLog?.createdBy ?? "-" }}
        </div>
        <div class="text-gray-600">
          <span class="font-medium text-gray-800">Created At:</span>
          {{
            selectedLog?.createdAt
              ? (selectedLog?.createdAt | date: "dd/MM/yy HH:mm")
              : "-"
          }}
        </div>
      </div>
      <div class="border-t pt-3">
        <div
          class="text-sm text-gray-800 dark:text-gray-200 whitespace-pre-wrap break-words leading-6"
        >
          {{ selectedLog?.message || "-" }}
        </div>
      </div>
    </div>
    <ng-template pTemplate="footer">
      <button
        pButton
        label="Close"
        icon="pi pi-times"
        class="p-button-text"
        (click)="messageDialogVisible = false"
      ></button>
    </ng-template>
  </p-dialog>
</div>
